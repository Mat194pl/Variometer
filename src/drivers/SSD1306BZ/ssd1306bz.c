/*
 * ssd1306bz.c
 *
 *  Created on: 2 mar 2018
 *      Author: Mateusz
 */

#include "ssd1306bz.h"
#include <string.h>

extern void SSD1306BZ_port_init(void);
extern void SSD1306BZ_port_read_data(uint8_t* data, uint16_t data_length);
extern void SSD1306BZ_port_write_data(uint8_t* data, uint16_t data_length);
extern void SSD1306BZ_delay_ms(uint16_t milliseconds);
extern void SSD1306BZ_port_set_reset(bool state);
extern void SSD1306BZ_port_set_lcd_on(bool state);

#define SSD1306_MEMORYMODE 0x20
#define SSD1306_COLUMNADDR 0x21
#define SSD1306_PAGEADDR   0x22
#define SSD1306_DEACTIVATE_SCROLL 0x2E
#define SSD1306_SETSTARTLINE 0x40
#define SSD1306_SETCONTRAST 0x81
#define SSD1306_CHARGEPUMP 0x8D
#define SSD1306_SEGREMAP 0xA0
#define SSD1306_DISPLAYALLON_RESUME 0xA4
#define SSD1306_NORMALDISPLAY 0xA6
#define SSD1306_SETMULTIPLEX 0xA8
#define SSD1306_DISPLAYOFF	0xAE
#define SSD1306_DISPLAYON 0xAF
#define SSD1306_COMSCANDEC 0xC8
#define SSD1306_SETDISPLAYOFFSET 0xD3
#define SSD1306_SETDISPLAYCLOCKDIV 0xD5
#define SSD1306_SETPRECHARGE 0xD9
#define SSD1306_SETCOMPINS 0xDA
#define SSD1306_SETVCOMDETECT 0xDB

#define SSD1306_LCD_HEIGHT	48
#define SSD1306_LCD_WIDTH	64

static void _send_command(uint8_t command);

// The memory buffer for the LCD
static uint8_t _buffer[SSD1306_LCD_HEIGHT * SSD1306_LCD_WIDTH / 8];
//static uint8_t ex_img[] = {
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x80, 0xE0, 0xF0, 0x90, 0xD0, 0x48, 0x48, 0x4C, 0x4C,
//		0x4C, 0x44, 0xC6, 0xC2, 0xC2, 0x82, 0x82, 0x82, 0x02, 0x02,
//		0x06, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x08, 0x08, 0x08, 0x18,
//		0x10, 0x10, 0x30, 0x60, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x19, 0x10, 0x20, 0x60,
//		0xB0, 0x18, 0x08, 0x0C, 0x06, 0x03, 0x01, 0x01, 0x01, 0x01,
//		0x07, 0x79, 0x81, 0x01, 0x03, 0x02, 0x06, 0x04, 0x0C, 0x18,
//		0x18, 0x30, 0x60, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00,
//		0x01, 0x03, 0x06, 0x04, 0x08, 0x18, 0x30, 0xE0, 0x80, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x0C, 0x10, 0x20, 0xC0,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x78, 0x80, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x1C, 0x03,
//		0x03, 0x02, 0x04, 0x0C, 0x18, 0x70, 0xC0, 0x80, 0x00, 0x00,
//		0x00, 0x00, 0x01, 0x87, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x08, 0x30, 0x40, 0x80,
//		0x00, 0x00, 0x07, 0x78, 0x80, 0x00, 0x00, 0x00, 0xC0, 0x38,
//		0x07, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x20, 0x10, 0x08,
//		0x04, 0x03, 0x02, 0x02, 0x02, 0x03, 0x01, 0x01, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x03, 0x04, 0x18, 0xA0, 0xC7, 0xF8,
//		0xF0, 0xCE, 0x21, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x0E, 0x0B, 0x0F, 0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//		0x00, 0x00, 0x00, 0x00
//};


void ssd1306bz_init(void) {
	memset(_buffer, 0, SSD1306_LCD_HEIGHT * SSD1306_LCD_WIDTH / 8);

	SSD1306BZ_port_init();
}

void ssd1306bz_update(void) {
//	memcpy(_buffer, ex_img, sizeof(_buffer));
	_send_command(SSD1306_COLUMNADDR);

	_send_command(32);   // Column start address (0 = reset)
	_send_command(95); // Column end address (127 = reset)

	_send_command(SSD1306_PAGEADDR);
	_send_command(0); // Page start address (0 = reset)
	_send_command(5); // Page end address

    // I2C

	for (uint8_t w = 0; w < 4 * (SSD1306_LCD_HEIGHT/8) ; w++) {

		uint8_t data_to_write[17];
		data_to_write[0] = 0x40;

		for (uint8_t i = 0; i < 16; i++) {
			data_to_write[i + 1] = _buffer[w * 16 + i];
		}

		SSD1306BZ_port_write_data(data_to_write, 17);
	}
}

void ssd1306bz_draw_image(
		int16_t pos_x,
		int16_t pos_y,
		uint8_t width,
		uint8_t height,
		const uint8_t* data) {
	uint8_t y_block_off_start;

	y_block_off_start = pos_y % 8;

	uint32_t read_idx = 0;
	uint8_t cur_byte = 0;
	uint8_t h_byte_offset = y_block_off_start;
	uint16_t max_idx = SSD1306_LCD_HEIGHT * SSD1306_LCD_WIDTH / 8;

	for (uint8_t h = 0; h < height; h++) {
		if (pos_y + h >= 0 && pos_y + h < SSD1306_LCD_WIDTH) {
			uint16_t h_buff_offset = ((h + pos_y) / 8) * SSD1306_LCD_WIDTH;

			for (uint8_t w = 0; w < width; w++) {
				cur_byte = data[read_idx];
				read_idx++;
				if (cur_byte != 0) {
					if (w + pos_x >= 0 && w + pos_x < SSD1306_LCD_WIDTH) {
						uint16_t idx = w + pos_x + h_buff_offset;
						if (idx < max_idx) {
							_buffer[idx] |= 1 << h_byte_offset;
						}
					}
				}
			}
		} else {
			read_idx += width;
		}
		h_byte_offset++;

		if (8 == h_byte_offset) {
			h_byte_offset = 0;
		}

	}
}

void ssd1306bz_clear_screen(void) {
	memset(_buffer, 0, SSD1306_LCD_HEIGHT * SSD1306_LCD_WIDTH / 8);
}

void ssd1306bz_turn_off(void) {
	SSD1306BZ_port_set_lcd_on(false);
}

void ssd1306bz_turn_on(void) {
	memset(_buffer, 0, SSD1306_LCD_HEIGHT * SSD1306_LCD_WIDTH / 8);

	SSD1306BZ_port_set_lcd_on(false);
	SSD1306BZ_delay_ms(50);
	SSD1306BZ_port_set_lcd_on(true);
	SSD1306BZ_port_set_reset(true);
	SSD1306BZ_delay_ms(1);
	SSD1306BZ_port_set_reset(false);
	// wait 10ms
	SSD1306BZ_delay_ms(10);
	// bring out of reset
	SSD1306BZ_port_set_reset(true);

	// Init sequence
	_send_command(SSD1306_DISPLAYOFF);                    // 0xAE

	_send_command(SSD1306_SETDISPLAYCLOCKDIV);            // 0xD5
	_send_command(0x80);                                  // the suggested ratio 0x80

	_send_command(SSD1306_SETMULTIPLEX);                  // 0xA8
	_send_command(SSD1306_LCD_HEIGHT - 1);

	_send_command(SSD1306_SETDISPLAYOFFSET);              // 0xD3
	_send_command(0x0);                                   // no offset
	_send_command(SSD1306_SETSTARTLINE | 0x0);            // line #0
	_send_command(SSD1306_CHARGEPUMP);                    // 0x8D
	_send_command(0x14);

	_send_command(SSD1306_MEMORYMODE);                    // 0x20
	_send_command(0x00);                                  // 0x0 act like ks0108
	_send_command(SSD1306_SEGREMAP | 0x1);
	_send_command(SSD1306_COMSCANDEC);

	// TODO SETCOMPNS and SETCONTRAST
	_send_command(SSD1306_SETCOMPINS);                    // 0xDA
	_send_command(0x12);
	_send_command(SSD1306_SETCONTRAST);                   // 0x81
	_send_command(0x8F);
	//TEST

	_send_command(SSD1306_SETPRECHARGE);                  // 0xd9
	_send_command(0xF1);

	_send_command(SSD1306_SETVCOMDETECT);                 // 0xDB
	_send_command(0x40);
	_send_command(SSD1306_DISPLAYALLON_RESUME);           // 0xA4
	_send_command(SSD1306_NORMALDISPLAY);                 // 0xA6

	_send_command(SSD1306_DEACTIVATE_SCROLL);

	_send_command(SSD1306_DISPLAYON);//--turn on oled panel
}

static void _send_command(uint8_t command) {
	uint8_t data_to_write[2];
	data_to_write[0] = 0x00;
	data_to_write[1] = command;

	SSD1306BZ_port_write_data(data_to_write, 2);
}
